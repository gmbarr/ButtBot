!function(){function e(e,s,n,o,i,r){var a="";if(l.pollRunning)return!1;l.pollRunning=!0,l.pollMaster=o,l.time=isNaN(n)||0==n?!1:1e3*n,l.callback=r,l.question=e,l.options=s,l.minVotes=i?i:1,l.votes=[],l.voters=[],l.counts=[],l.hasTie=0;for(var p=0;p<l.options.length;p++)a+=p+1+") "+l.options[p]+" ";return $.say($.lang.get("pollsystem.poll.started",$.resolveRank(o),n,l.minVotes,l.question,a)),l.time&&(l.pollTimerId=setTimeout(function(){t(),clearTimeout(l.pollTimerId)},l.time)),!0}function s(e,s){var t;return l.pollRunning||$.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.nopoll")),$.list.contains(l.voters,e.toLowerCase())?void $.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.already")):(t=parseInt(s),isNaN(t)||1>t||t>l.options.length?void $.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.invalid",s)):(t--,$.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.success",l.options[t],l.question)),l.voters.push(e),void l.votes.push(t)))}function t(){var e,s=-1;if(l.pollRunning){if(l.pollTimerId>-1&&(clearTimeout(l.pollTimerId),l.pollTimerId=-1),l.minVotes>0&&l.votes.length<l.minVotes)return l.result="",l.pollMaster="",l.pollRunning=!1,void l.callback(!1);for(e=0;e<l.options.length;l.counts.push(0),e++);for(e=0;e<l.votes.length;l.counts[l.votes[e++]]+=1);for(e=0;e<l.counts.length;winner=l.counts[e]>s?e:winner,s=l.counts[e]>s?l.counts[e]:s,e++);for(e=0;e<l.counts.length;e!=winner&&l.counts[e]==l.counts[winner]?l.hasTie=1:0,1==l.hasTie?e=l.counts.length:0,e++);l.result=l.options[winner],l.pollMaster="",l.pollRunning=!1,l.callback(l.result)}}var l={pollId:0,options:[],votes:[],voters:[],callback:function(){},pollRunning:!1,pollMaster:"",time:0,question:"",minVotes:0,result:"",pollTimerId:-1,hasTie:0,counts:[]},n=new RegExp(/"([\w\W]+)"\s+"([\w\W]+)"\s+(\d+)\s+(\d+)/),o=new RegExp(/"([\w\W]+)"\s+"([\w\W]+)"\s+(\d+)/),i=new RegExp(/"([\w\W]+)"\s+"([\w\W]+)"/);$.bind("command",function(r){var a=r.getSender().toLowerCase(),p=r.getCommand(),u=r.getArguments().trim(),g=r.getArgs(),m=g[0];if(p.equalsIgnoreCase("vote")&&m){if(!l.pollRunning)return void $.say($.whisperPrefix(a)+$.lang.get("pollsystem.vote.nopoll"));s(a,m)}if(p.equalsIgnoreCase("poll")){if(!m){if(l.pollRunning)$.say($.whisperPrefix(a)+$.lang.get("pollsystem.poll.running",l.question,l.options.join('", "')));else{if(!$.isMod(a))return void $.say($.whisperPrefix(a)+$.modMsg);$.say($.whisperPrefix(a)+$.lang.get("pollsystem.poll.usage"))}return}if(!$.isMod(a))return void $.say($.whisperPrefix(a)+$.modMsg);if(m.equalsIgnoreCase("results")&&(l.pollRunning?$.say($.lang.get("pollsystem.results.running")):""!=l.result?l.hasTie?$.say($.lang.get("pollsystem.results.lastpoll",l.question,l.votes.length,"Tie!",l.options.join('", "'),l.counts.join('", "'))):$.say($.lang.get("pollsystem.results.lastpoll",l.question,l.votes.length,l.result,l.options.join('", "'),l.counts.join(", "))):$.say($.whisperPrefix(a)+$.lang.get("pollsystem.results.404"))),m.equalsIgnoreCase("open")){var y=60,c="",h=[],f=1;if(u+="",u.match(n))c=u.match(n)[1],h=u.match(n)[2].split(/,\s*/),y=parseInt(u.match(n)[3]),f=parseInt(u.match(n)[4]);else if(u.match(o))c=u.match(o)[1],h=u.match(o)[2].split(/,\s*/),y=parseInt(u.match(o)[3]);else{if(!u.match(i))return void $.say($.whisperPrefix(a)+$.lang.get("pollsystem.open.usage"));c=u.match(i)[1],h=u.match(i)[2].split(/,\s*/)}if(isNaN(y)||!c||!h||0==h.length||isNaN(f)||1>f)return void $.say($.whisperPrefix(a)+$.lang.get("pollsystem.open.usage"));if(1==h.length)return void $.say($.whisperPrefix(a)+$.lang.get("pollsystem.open.moreoptions"));e(c,h,0==y?60:y,a,f,function(e){return e===!1?void $.say($.lang.get("pollsystem.runpoll.novotes",c)):void(l.hasTie?$.say($.lang.get("pollsystem.runpoll.tie",c)):$.say($.lang.get("pollsystem.runpoll.winner",c,e)))})?$.say($.whisperPrefix(a)+$.lang.get("pollsystem.runpoll.started")):$.say($.whisperPrefix(a)+$.lang.get("pollsystem.results.running"))}if(m.equalsIgnoreCase("close")){if(!l.pollRunning)return void $.say($.whisperPrefix(a)+$.lang.get("pollsystem.close.nopoll"));t()}}}),$.bind("initReady",function(){$.bot.isModuleEnabled("./systems/pollSystem.js")&&($.registerChatCommand("./systems/pollSystem.js","poll",7),$.registerChatCommand("./systems/pollSystem.js","vote",7))}),$.poll={runPoll:e,endPoll:t}}();
