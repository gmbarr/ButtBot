!function(){function e(e,s,t,n,i,r){var a="";if(o.pollRunning)return!1;o.pollRunning=!0,o.pollMaster=n,o.time=isNaN(t)||0==t?!1:1e3*t,o.callback=r,o.question=e,o.options=s,o.minVotes=i?i:1,o.votes=[],o.voters=[];for(var p=0;p<o.options.length;p++)a+=p+1+") "+o.options[p]+" ";return $.say($.lang.get("pollsystem.poll.started",$.resolveRank(n),t,o.question,a)),o.time&&(o.pollTimerId=setTimeout(function(){l(),clearTimeout(o.pollTimerId)},o.time)),!0}function s(e,s){var l;return o.pollRunning||$.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.nopoll")),$.list.contains(o.voters,e.toLowerCase())?void $.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.already")):(l=parseInt(s),isNaN(l)||1>l||l>o.options.length?void $.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.invalid",s)):(l--,$.say($.whisperPrefix(e)+$.lang.get("pollsystem.vote.success",o.options[l],o.question)),o.voters.push(e),void o.votes.push(l)))}function l(){var e,s=[],l=-1;if(o.pollRunning){if(o.pollTimerId>-1&&(clearTimeout(o.pollTimerId),o.pollTimerId=-1),o.minVotes>0&&o.votes.length<o.minVotes)return o.result="",o.pollMaster="",o.pollRunning=!1,void o.callback(!1);for(e=0;e<o.options.length;s.push(0),e++);for(e=0;e<o.votes.length;s[o.votes[e++]]+=1);for(e=1;e<s.length;winner=s[e]>l?e:winner,l=s[e]>l?s[e]:l,e++);o.result=o.options[winner],o.pollMaster="",o.pollRunning=!1,o.callback(o.result)}}var o={pollId:0,options:[],votes:[],voters:[],callback:function(){},pollRunning:!1,pollMaster:"",time:0,question:"",minVotes:0,result:"",pollTimerId:-1};$.bind("command",function(t){var n=t.getSender().toLowerCase(),i=t.getCommand(),r=t.getArguments().trim(),a=t.getArgs(),p=a[0];if(i.equalsIgnoreCase("vote")&&p){if(!o.pollRunning)return void $.say($.whisperPrefix(n)+$.lang.get("pollsystem.vote.nopoll"));s(n,p)}if(i.equalsIgnoreCase("poll")){if(!p){if(o.pollRunning)$.say($.whisperPrefix(n)+$.lang.get("pollsystem.poll.running",o.question,o.options.join('", "')));else{if(!$.isMod(n))return void $.say($.whisperPrefix(n)+$.modMsg);$.say($.whisperPrefix(n)+$.lang.get("pollsystem.poll.usage"))}return}if(!$.isMod(n))return void $.say($.whisperPrefix(n)+$.modMsg);if(p.equalsIgnoreCase("results")&&(o.pollRunning?$.say($.lang.get("pollsystem.results.running")):""!=o.result?$.say($.lang.get("pollsystem.results.lastpoll",o.question,o.votes.length,o.result,o.options.join('", "'))):$.say($.whisperPrefix(n)+$.lang.get("pollsystem.results.404"))),p.equalsIgnoreCase("open")){var g=60,u="",m=[],y=1;if(r+="",r.match(/-t\s+([0-9]+)/)&&(g=parseInt(r.match(/-t\s+([0-9]+)/)[1])),r.match(/-q\s+"(.*)"\s+/)&&(u=r.match(/-q\s+"(.*)"\s+/)[1]),r.match(/-o\s+"(.+)"/)&&(m=r.match(/-o\s+"(.+)"/)[1].split(/,\s*/)),r.match(/-m\s+([0-9]+)/)&&(y=parseInt(r.match(/-m\s+([0-9])+/)[1])),isNaN(g)||!u||!m||0==m.length||isNaN(y)||1>y)return void $.say($.whisperPrefix(n)+$.lang.get("pollsystem.open.usage"));if(1==m.length)return void $.say($.whisperPrefix(n)+$.lang.get("pollsystem.open.moreoptions"));e(u,m,g,n,y,function(e){return e===!1?void $.say($.lang.get("pollsystem.runpoll.novotes",u)):void $.say($.lang.get("pollsystem.runpoll.winner",u,e))}),$.say($.whisperPrefix(n)+$.lang.get("pollsystem.runpoll.started"))}if(p.equalsIgnoreCase("close")){if(!o.pollRunning)return void $.say($.whisperPrefix(n)+$.lang.get("pollsystem.close.nopoll"));l()}}}),$.bind("initReady",function(){$.bot.isModuleEnabled("./systems/pollSystem.js")&&($.registerChatCommand("./systems/pollSystem.js","poll",7),$.registerChatCommand("./systems/pollSystem.js","vote",7))}),$.poll={runPoll:e,endPoll:l}}();
