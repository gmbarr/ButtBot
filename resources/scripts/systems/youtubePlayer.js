!function(){function e(e,t){this.youtubeVideo=e,this.username=t,this.isOverRequestLimit=function(){var e,t=0;for(e in x)x[e].username==this.username&&t++;return t>=g},this.isQueueDuplicate=function(){var e;for(e in x)if(x[e].videoId==this.youtubeVideo.videoId)return!0;return!1},this.isVideoTooLong=function(){return parseInt(this.youtubeVideo.getVideoLength())>parseInt(f)},this.request=function(){return this.youtubeVideo.found?this.isOverRequestLimit()?($.say($.whisperPrefix(this.username)+$.lang.get("youtubeplayer.request.error.overlimit",g)),$.returnCommandCost(this.username,"addsong"),!1):this.isQueueDuplicate()?($.say($.whisperPrefix(this.username)+$.lang.get("youtubeplayer.request.error.alreadyexists")),$.returnCommandCost(this.username,"addsong"),!1):this.isVideoTooLong()?($.say($.whisperPrefix(this.username)+$.lang.get("youtubeplayer.request.error.toolong",this.youtubeVideo.videoTitle,$.getTimeString(this.youtubeVideo.getVideoLength()),$.getTimeString(f))),$.returnCommandCost(this.username,"addsong"),!1):(x.push(this.youtubeVideo),o(),$.say($.lang.get("youtubeplayer.request.success",this.youtubeVideo.videoTitle,$.resolveRank(this.username))),null==C&&i(),!0):($.say($.whisperPrefix(this.username)+$.lang.get("youtubeplayer.request.error.404",this.youtubeVideo.link)),$.returnCommandCost(this.username,"addsong"),!1)}}function t(e,t){this.link=e,this.username=(t+"").toLowerCase(),this.videoId="",this.videoTitle="",this.length=0,this.found=!0,this.getVideoLength=function(){for(var e=$.youtube.GetVideoLength(this.videoId);0==e[0]&&0==e[1]&&0==e[2];)e=$.youtube.GetVideoLength(this.videoId);return 0==e[0]&&0==e[1]&&0==e[2]?!1:(this.length=e[2],this.length)},this.cue=function(){$.musicplayer.cue(this.videoId)},this.link||(this.found=!1);for(var s=$.youtube.SearchForVideo(this.link);s[0].length()<11&&"No Search Results Found"!=s[1];)s=$.youtube.SearchForVideo(this.link);this.videoId=s[0],this.videoTitle=s[1],this.length=1,("Video Marked Private"==this.videoTitle||"No Search Results Found"==this.videoTitle)&&(this.found=!1),""==this.videoId&&(this.found=!1)}function s(){var e,s;if($.consoleLn($.lang.get("youtubeplayer.playlist.parse.default.start")),w=$.readFile(b+"playlist.txt").reverse(),w.length>0)for(e=0;e<w.length;e++)s=new t(w[e]),s?$.writeToFile(e+". "+s.videoTitle+" ("+s.link+")",b+"defaultPlaylist.txt",0!=e):$.writeToFile(e+". COULD NOT FIND! ("+s.link+")",b+"defaultPlaylist.txt",0!=e);$.consoleLn($.lang.get("youtubeplayer.playlist.parse.default.complete"))}function i(){var e,s;if(e=null,x.length>0)e=x.shift();else if(0==w.length)e=null;else{if(h){do s=$.randRange(0,w.length-1);while(s==P);v=P=s}else v<w.length?v++:v=0;e=new t(w[v],$.botName)}null==e?($.lang.exists("youtubeplayer.nothing-to-play")&&$.say($.lang.get("youtubeplayer.nothing-to-play")),C=null):u(e)}function a(e){var s,i;for(s in w)if(w[s].toLowerCase().indexOf(e.toLowerCase())>-1)return v=s,i=new t(w[s],$.botName),u(i),!0;return!1}function r(e){$.writeToFile("http://youtube.com/watch?v="+e.videoId,"./addons/youtubePlayer/playlist.txt",!0),s()}function n(e){var i,a,r=new t(w[e]);w.splice(e,1),i=w.reverse();for(a in i)$.writeToFile(i[a],"./addons/youtubePlayer/playlist.txt",0!=a);return s(),r.videoTitle}function u(e){e&&(C=e,e.cue(),$.writeToFile(e.videoTitle,b+"currentSong.txt",!1),y?$.say($.lang.get("youtubeplayer.nowplaying.get",e.videoTitle,$.resolveRank(e.username))):$.consoleLn($.lang.get("youtubeplayer.nowplaying.get",e.videoTitle,$.resolveRank(e.username)))),o()}function o(e){var t;if(e)return void $.writeToFile("",b+"requestQueue.txt",!1);if(x.length>0)for(t in x)$.writeToFile(x[t].videoTitle+" (By "+$.username.resolve(x[t].username)+")",b+"requestQueue.txt",0!=t)}function l(){c?$.musicplayer.play():$.musicplayer.pause(),c=!c}var y=$.inidb.exists("youtubePlayer","updatesInChat")?$.getIniDbBoolean("youtubePlayer","updatesInChat"):!1,g=$.inidb.exists("youtubePlayer","requestLimit")?parseInt($.inidb.get("youtubePlayer","requestLimit")):3,d=$.inidb.exists("youtubePlayer","playerVolume")?parseInt($.inidb.get("youtubePlayer","playerVolume")):20,h=$.inidb.exists("youtubePlayer","shuffleDefaultPlaylist")?$.getIniDbBoolean("youtubePlayer","shuffleDefaultPlaylist"):!1,p=$.inidb.exists("youtubePlayer","requestsEnabled")?$.getIniDbBoolean("youtubePlayer","requestsEnabled"):!0,f=$.inidb.exists("youtubePlayer","maxVideoLength")?parseInt($.inidb.get("youtubePlayer","maxVideoLength")):600,b="./addons/youtubePlayer/",m=!1,c=!1,v=-1,P=-1,w=[],x=[],C=null;$.bind("musicPlayerConnect",function(){m=!0,$.youtubePlayerConnected=m,0==w.length&&s(),y&&p&&$.say($.lang.get("youtubeplayer.requests.enabled")+" "+$.lang.get("youtubeplayer.request.usage"))}),$.bind("musicPlayerDisconnect",function(){m=!1,$.youtubePlayerConnected=m,o(!0),y&&p&&$.say("[â™«] Song requests have been disabled.")}),$.bind("musicPlayerState",function(e){$.musicplayer.setVolume(d),-2==e.getStateId()&&(x=[],i()),0==e.getStateId()&&i(),5==e.getStateId()&&($.musicplayer.play(),$.musicplayer.currentId())}),$.bind("command",function(u){var o,c=u.getSender().toLowerCase(),v=u.getCommand(),P=u.getArgs(),I=P[0]?P[0]:"",q=P[1];if(v.equalsIgnoreCase("musicplayer")){if(!$.isAdmin(c))return void $.say($.whisperPrefix(c)+$.adminMsg);if(I.equalsIgnoreCase("togglenotify")&&(y=!y,$.setIniDbBoolean("youtubePlayer","updatesInChat",y),$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.toggle.chatnotifications.success",y?$.lang.get("common.enabled"):$.lang.get("common.disabled")))),I.equalsIgnoreCase("limit")){if(!q||isNaN(parseInt(q)))return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.set.requestlimit.usage",g));g=parseInt(q),$.inidb.set("youtubePlayer","requestLimit",g),$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.set.requestlimit.success",g))}if(I.equalsIgnoreCase("maxvideolength")){if(!q||isNaN(parseInt(q)))return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.set.maxvideolength.usage",$.getTimeString(f)));f=60*parseInt(q),$.inidb.set("youtubePlayer","maxVideoLength",f),$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.set.maxvideolength.success",$.getTimeString(f)))}if(I.equalsIgnoreCase("shuffle")&&(h=!h,$.setIniDbBoolean("youtubePlayer","shuffleDefaultPlaylist",h),$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.toggle.songshuffle.success",h?$.lang.get("common.enabled"):$.lang.get("common.disabled")))),I.equalsIgnoreCase("pause")&&l(),I.equalsIgnoreCase("reload")&&(s(),$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playlist.reload.success"))),I.equalsIgnoreCase("adddefault")){if(!q)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playlist.adddefault.usage"));o=new t(q,c),o?(r(o),$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playlist.adddefault.success",o.videoTitle))):$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playlist.adddefault.failed"))}if(I.equalsIgnoreCase("deldefault")){if(q=parseInt(q),isNaN(q)||!w[q])return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playlist.deletedefault.usage"));$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playlist.deletedefault.success",n(q)))}}if(v.equalsIgnoreCase("addsong")){if(!p)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.request.error.disabled"));if(!I)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.request.usage"));if(!m)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.request.error.notrunning"));o=new e(new t(P.join(" "),c),c),o.youtubeVideo&&o.request()}if(v.equalsIgnoreCase("volume")){if(!$.isAdmin(c))return void $.say($.whisperPrefix(c)+$.adminMsg);q||isNaN(parseInt(I))||(d=parseInt(I),$.inidb.set("youtubePlayer","playerVolume",d),m&&$.musicplayer.setVolume(d))}if(v.equalsIgnoreCase("skipsong")){if(!$.isAdmin(c))return void $.say($.whisperPrefix(c)+$.adminMsg);if(!m)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.notrunning"));i()}if(v.equalsIgnoreCase("currentsong")){if(!m)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.notrunning"));null!=C?$.say($.lang.get("youtubeplayer.nowplaying.getwithlink",C.videoTitle,$.resolveRank(C.username),C.link)):$.lang.exists("youtubeplayer.nothing-to-play")&&$.say($.lang.get("youtubeplayer.nothing-to-play"))}if(v.equalsIgnoreCase("stealsong")){if(!$.isAdmin(c))return void $.say($.whisperPrefix(c)+$.adminMsg);C&&($.writeToFile("https://youtube.com/watch?v="+C.videoId,b+"playlist.txt",!0),$.say($.lang.get("youtubeplayer.stealsong.success",C.videoTitle,$.resolveRank(C.username))),s())}if(v.equalsIgnoreCase("playsong")){if(!$.isAdmin(c))return void $.say($.whisperPrefix(c)+$.adminMsg);if(!m)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.notrunning"));if(x.length>0)return void $.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playsong.requestsrunning"));I&&(a(I)||$.say($.whisperPrefix(c)+$.lang.get("youtubeplayer.playsong.404",I)))}if(v.equalsIgnoreCase("togglerequests")){if(!$.isAdmin(c))return void $.say($.whisperPrefix(c)+$.adminMsg);p=!p,$.setIniDbBoolean("youtubePlayer","requestsEnabled",p),p?$.say($.lang.get("youtubeplayer.requests.enabled")):$.say($.lang.get("youtubeplayer.requests.disabled"))}}),$.bind("initReady",function(){$.bot.isModuleEnabled("./systems/youtubePlayer.js")&&(0==w.length&&s(),$.registerChatCommand("./systems/youtubePlayer.js","musicplayer",1),$.registerChatCommand("./systems/youtubePlayer.js","volume",1),$.registerChatCommand("./systems/youtubePlayer.js","skipsong",1),$.registerChatCommand("./systems/youtubePlayer.js","stealsong",1),$.registerChatCommand("./systems/youtubePlayer.js","playsong",1),$.registerChatCommand("./systems/youtubePlayer.js","togglerequests",1),$.registerChatCommand("./systems/youtubePlayer.js","addsong",6),$.registerChatCommand("./systems/youtubePlayer.js","currentsong",7))})}();
