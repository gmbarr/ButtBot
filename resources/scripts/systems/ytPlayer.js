!function(){function e(e,t){var s="",n="",i=-1;if(this.found=!1,this.getVideoId=function(){return s},this.getOwner=function(){return t},this.getVideoLength=function(){if(-1!=i)return i;for(var e=$.youtube.GetVideoLength(s);0==e[0]&&0==e[1]&&0==e[2];)e=$.youtube.GetVideoLength(s);return 0==e[0]&&0==e[1]&&0==e[2]?0:(i=e[2],e[2])},this.getVideoLengthMMSS=function(){var e,t;return-1==i&&(i=this.getVideoLength()),e=(10>i/60?"0":"")+Math.floor(i/60),t=(10>i%60?"0":"")+Math.floor(i%60),e+":"+t},this.getVideoLink=function(){return"https://youtu.be/"+s},this.getVideoTitle=function(){return n},!e)throw"No Search Query Given";t=t.toLowerCase();var a=null;do a=$.youtube.SearchForVideo(e);while(a[0].length()<11&&"No Search Results Found"!=a[1]);if(s=a[0],n=a[1],n.equalsIgnoreCase("video marked private")||n.equalsIgnoreCase("no search results found"))throw n}function t(t){var s=null,r=null,u=n+t,d=[],c=[];return requests=[],requestFailReason="",this.playlistName=t,this.loaded=!1,this.loadNewPlaylist=function(e){$.inidb.exists("yt_playlists_registry","ytPlaylist_"+e)&&(this.playlistName=e,u=n+e,this.loadPlaylistKeys(),connectedPlayerClient.pushPlayList())},this.getplayListDbId=function(){return u},this.getRequestFailReason=function(){return requestFailReason},this.addToPlaylist=function(e,t){if(!e)return-1;var s;return t=t?t:this.playlistName,this.videoExistsInPlaylist(e,t)?-1:(t&&(s=parseInt($.inidb.GetKeyList(n+t,"").length)+1,$.inidb.set(n+t,s,e.getVideoId())),t.equals(this.playlistName)&&(this.loadPlaylistKeys(),connectedPlayerClient.pushPlayList()),s)},this.deleteCurrentVideo=function(){var e,t=$.inidb.GetKeyList(u,"");for(e=0;e<t.length;e++)if($.inidb.get(u,t[e])==r.getVideoId()){$.inidb.del(u,t[e]);break}return this.loadPlaylistKeys()>0?(connectedPlayerClient.pushPlayList(),this.nextVideo()):connectedPlayerClient.pushPlayList(),this.getplaylistLength()},this.deletePlaylist=function(e){return $.inidb.exists("yt_playlists_registry","ytPlaylist_"+e)?($.inidb.del("yt_playlists_registry","ytPlaylist_"+e),$.inidb.RemoveFile("ytPlaylist_"+e),!0):!1},this.getCurrentVideo=function(){return r},this.getPlaylistname=function(){return this.playlistName},this.getplaylistLength=function(){return d.length},this.getReadOnlyPlaylistData=function(){return c},this.getPreviousVideo=function(){return s},this.getRequestList=function(){return requests},this.getRequestAtIndex=function(e){return e>requests.length?null:requests[e]},this.getRequestsCount=function(){return requests.length},this.jumpToSong=function(t){if($.inidb.exists(u,t)){s=r;try{r=new e($.inidb.get(u,t),$.botName)}catch(n){return $.logError("ytPlayer.js",233,"YoutubeVideo::exception: "+n),!1}return connectedPlayerClient.play(r),!0}return!1},this.loadPlaylistKeys=function(){var e=$.inidb.GetKeyList(u,"");d=[],c=[];for(var t=0;t<e.length;t++)d.push(e[t]);return d=i?$.arrayShuffle(d):d,c=d,this.loaded=!0,e.length},this.nextVideo=function(){if(!connectedPlayerClient)return null;if(s=r,requests.length>0)r=requests.shift();else{if(0==d.length&&0==this.loadPlaylistKeys())return null;try{var t=d.shift();r=new e($.inidb.get(u,t),$.botName)}catch(n){$.logError("ytPlayer.js",277,"YoutubeVideo::exception: "+n),this.nextVideo()}}return connectedPlayerClient.play(r),this.updateCurrentSongFile(r),a&&$.say($.lang.get("ytplayer.announce.nextsong",r.getVideoTitle(),r.getOwner())),r},this.preparePlaylist=function(){return $.inidb.set("ytSettings","activePlaylistname","default"),$.inidb.exists("yt_playlists_registry",u)&&$.inidb.FileExists(u)||($.setIniDbBoolean("yt_playlists_registry",u,!0),$.inidb.AddFile(u)),!0},this.removeSong=function(e){var t,s=null,n=[];for(t in requests)requests[t].getVideoId().equals(e)?s=requests[t].getVideoTitle():n.push(requests[t]);return requests=n,s},this.removeUserSong=function(e){var t,s=null,n=[];for(t=requests.length-1;t>=0;t--)requests[t].getOwner().equals(e)&&null==s?s=requests[t].getVideoTitle():n.push(requests[t]);return requests=n,s},this.requestSong=function(t,s){if(!$.isAdmin(s)&&(!o||this.senderReachedRequestMax(s)))return this.senderReachedRequestMax(s)?requestFailReason=$.lang.get("ytplayer.requestsong.error.maxrequests"):requestFailReason=$.lang.get("ytplayer.requestsong.error.disabled"),null;try{var n=new e(t,s)}catch(i){return requestFailReason=$.lang.get("ytplayer.requestsong.error.yterror",i),$.logError("ytPlayer.js",315,"YoutubeVideo::exception: "+i),null}if(this.videoExistsInRequests(n))return requestFailReason=$.lang.get("ytplayer.requestsong.error.exists"),null;if(this.videoLengthExceedsMax(n))return requestFailReason=$.lang.get("ytplayer.requestsong.error.maxlength"),null;requests.push(n);var a=connectedPlayerClient.checkState();return a!=playerStateEnum.UNSTARTED&&a!=playerStateEnum.ENDED||this.nextVideo(),n},this.senderReachedRequestMax=function(e){var t,s=0;e=e.toLowerCase();for(t in requests)requests[t].getOwner()==e&&++s;return s>=y},this.updateCurrentSongFile=function(e){$.writeToFile(e.getVideoTitle(),l+"currentSong.txt",!1)},this.videoExistsInPlaylist=function(e,t){var s,i=$.inidb.GetKeyList(n+t,"");for(s in i)if($.inidb.get(n+t,i[s])==e.getVideoId)return!0;return!1},this.videoExistsInRequests=function(e){var t;for(t in requests)if(requests[t].getVideoId()==e.getVideoId())return!0;return!1},this.videoLengthExceedsMax=function(e){return e.getVideoLength()>g},this.playlistName?(this.preparePlaylist(),void this.loadPlaylistKeys()):this.loaded}function s(){var t=$.ytplayer,s=!1;this.pushPlayList=function(){var s,n,i={},a=[];if(currentPlaylist){for(i.playlistname=currentPlaylist.getPlaylistname()+"",i.playlist=[],a=currentPlaylist.getReadOnlyPlaylistData(),n=0;n<a.length;n++)s=new e($.inidb.get(currentPlaylist.getplayListDbId(),a[n]),$.botName),i.playlist.push({song:s.getVideoId()+"",title:s.getVideoTitle()+"",duration:s.getVideoLengthMMSS()+""});t.playList(JSON.stringify(i))}},this.pushSongList=function(){var e,s,n={},i=[];if(currentPlaylist){n.songlist=[],i=currentPlaylist.getRequestList();for(s in i)e=i[s],n.songlist.push({song:e.getVideoId()+"",title:e.getVideoTitle()+"",duration:e.getVideoLengthMMSS()+"",requester:e.getOwner()+""});t.songList(JSON.stringify(n))}},this.play=function(e){t.play(e.getVideoId(),e.getVideoTitle(),e.getVideoLengthMMSS(),e.getOwner())},this.getVolume=function(){return t.getVolume()},this.setVolume=function(e){e=parseInt(e),isNaN(e)||(t.setVolume(e),$.inidb.set("ytSettings","volume",e))},this.togglePause=function(){return t.pause(),s=!s},this.checkState=function(){return parseInt(t.getPlayerState())}}var n="ytPlaylist_",i=$.inidb.exists("ytSettings","randomizePlaylist")?$.getIniDbBoolean("ytSettings","randomizePlaylist"):!1,a=$.inidb.exists("ytSettings","announceInChat")?$.getIniDbBoolean("ytSettings","announceInChat"):!1,r=$.inidb.exists("ytSettings","activePlaylistname")?$.inidb.get("ytSettings","activePlaylistname"):"default",l=$.inidb.exists("ytSettings","baseFileOutputPath")?$.inidb.get("ytSettings","baseFileOutputPath"):"./addons/youtubePlayer/",o=$.inidb.exists("ytSettings","songRequestsEnabled")?$.getIniDbBoolean("ytSettings","songRequestsEnabled"):!1,y=$.inidb.exists("ytSettings","songRequestsMaxParallel")?parseInt($.inidb.get("ytSettings","songRequestsMaxParallel")):1,g=$.inidb.exists("ytSettings","songRequestsMaxSecondsforVideo")?parseInt($.inidb.get("ytSettings","songRequestsMaxSecondsforVideo")):480;playerStateEnum={NEW:-2,UNSTARTED:-1,ENDED:0,PLAYING:1,PAUSED:2,BUFFERING:3,CUED:5,KEEPALIVE:200},connectedPlayerClient=null,currentPlaylist=null,$.bind("yTPlayerDeleteSREvent",function(e){currentPlaylist.removeSong(e.getId()),connectedPlayerClient.pushSongList()}),$.bind("yTPlayerRequestSonglist",function(e){connectedPlayerClient.pushSongList()}),$.bind("yTPlayerRequestPlaylist",function(e){connectedPlayerClient.pushPlayList()}),$.bind("yTPlayerState",function(e){var t,s=e.getStateId();s==playerStateEnum.NEW&&(currentPlaylist&&currentPlaylist.nextVideo(),t=$.inidb.exists("ytSettings","volume")?parseInt($.inidb.get("ytSettings","volume")):5,connectedPlayerClient.setVolume(t)),s==playerStateEnum.ENDED&&currentPlaylist&&currentPlaylist.nextVideo()}),$.bind("yTPlayerConnect",function(e){connectedPlayerClient=new s,$.consoleLn($.lang.get("ytplayer.console.client.connected")),o&&$.say($.lang.get("ytplayer.songrequests.enabled")),connectedPlayerClient.pushPlayList()}),$.bind("yTPlayerDisconnect",function(e){connectedPlayerClient=null,$.consoleLn($.lang.get("ytplayer.console.client.disconnected")),o||$.say($.lang.get("ytplayer.songrequests.disabled"))}),$.bind("command",function(s){var r,l,u,d=s.getCommand(),c=s.getSender().toLowerCase(),p=s.getArgs();if(d.equalsIgnoreCase("ytp")){if(r=["volume","pause"].join(", "),l=p[0],u=p.splice(1),!l)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.ytp.usage"));if(l.equalsIgnoreCase("delrequest")){if(u[0]){var m=currentPlaylist.removeSong(u[0]);m?($.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.delrequest.success",u[0],m)),connectedPlayerClient.pushSongList()):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.delrequest.404",u[0]))}else $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.delrequest.usage"));return}if(l.equalsIgnoreCase("volume"))return connectedPlayerClient?void(u[0]&&!isNaN(parseInt(u[0]))?(connectedPlayerClient.setVolume(u[0]),$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.volume.set",u[0]))):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.volume.get",connectedPlayerClient.getVolume()))):void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.client.404"));if(l.equalsIgnoreCase("pause"))return void connectedPlayerClient.togglePause();if(l.equalsIgnoreCase("togglerandom"))return i=!i,$.setIniDbBoolean("ytSettings","randomizePlaylist",i),currentPlaylist&&currentPlaylist.loadPlaylistKeys(),connectedPlayerClient&&connectedPlayerClient.pushPlayList(),void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.ytp.togglerandom.toggled",i?$.lang.get("common.enabled"):$.lang.get("common.disabled")));if(l.equalsIgnoreCase("toggleannounce"))return a=!a,$.setIniDbBoolean("ytSettings","announceInChat",a),void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.ytp.toggleannounce.toggled",i?$.lang.get("common.enabled"):$.lang.get("common.disabled")));if(l.equalsIgnoreCase("togglesongrequests"))return o=!o,$.setIniDbBoolean("ytSettings","songRequestsEnabled",o),void(o?$.say($.lang.get("ytplayer.songrequests.enabled")):$.say($.lang.get("ytplayer.songrequests.disabled")));if(l.equalsIgnoreCase("setrequestmax"))return!u[0]||isNaN(parseInt(u[0]))?void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.ytp.setrequestmax.usage")):(y=parseInt(u[0]),$.inidb.set("ytSettings","songRequestsMaxParallel",y),void $.say($.lang.get("ytplayer.command.ytp.setrequestmax.success",y)));if(l.equalsIgnoreCase("setmaxvidlength"))return!u[0]||isNaN(parseInt(u[0]))?void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.ytp.setmaxvidlength.usage")):(g=parseInt(u[0]),$.inidb.set("ytSettings","songRequestsMaxParallel",g),void $.say($.lang.get("ytplayer.command.ytp.setmaxvidlength.success",g)))}if(d.equalsIgnoreCase("playlist")){if(r=["add","delete","loadpl","deletepl","importpl"].join(", "),l=p[0],u=p.splice(1),!l)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.usage",r));if(l.equalsIgnoreCase("add")){if(!connectedPlayerClient)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.client.404"));if(u.length>0){try{var P=new e(u.join(" "),c)}catch(h){return $.logError("ytPlayer.js",641,"YoutubeVideo::exception: "+h),void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.add.failed",h))}currentPlaylist.addToPlaylist(P)?$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.add.success",P.getVideoTitle(),currentPlaylist.getPlaylistname())):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.add.failed",currentPlaylist.getRequestFailReason()))}else $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.add.usage"));return}if(l.equalsIgnoreCase("delete"))return connectedPlayerClient?void currentPlaylist.deleteCurrentVideo():void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.client.404"));if(l.equalsIgnoreCase("loadpl")){if(!connectedPlayerClient)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.client.404"));if(u.length>0){var f=new t(u[0]);0==f.getplaylistLength()?$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.load.success.new",f.getPlaylistname())):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.load.success",f.getPlaylistname())),currentPlaylist.loadNewPlaylist(u[0]),connectedPlayerClient.pushPlayList()}else $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.load.usage"));return}if(l.equalsIgnoreCase("listpl")){var x=$.inidb.GetKeyList("yt_playlists_registry","");x&&$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.listpl",x.join(", ").replace(/ytPlaylist_/g,"")))}if(l.equalsIgnoreCase("deletepl")){if(!currentPlaylist)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.client.404"));if(u.length>0){if(u[0].equalsIgnoreCase("default"))return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.delete.isdefault"));currentPlaylist.deletePlaylist(u[0])?$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.delete.success",u[0])):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.delete.404",u[0]))}else $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.playlist.delete.usage"));return}return void(l.equalsIgnoreCase("importpl")&&$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.importpl.notsupported")))}if(null==connectedPlayerClient)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.client.404"));if(d.equalsIgnoreCase("stealsong")&&(0==p.length?(currentPlaylist.addToPlaylist(currentPlaylist.getCurrentVideo()),$.say($.lang.get("ytplayer.command.stealsong.this.success",$.username.resolve(c)))):$.inidb.FileExists(n+p[0].toLowerCase())?(currentPlaylist.addToPlaylist(currentPlaylist.getCurrentVideo(),p[0].toLowerCase()),$.say($.lang.get("ytplayer.command.stealsong.other.success",$.username.resolve(c),p[0]))):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.playlist.404",p[0]))),d.equalsIgnoreCase("jumptosong")&&(currentPlaylist.jumpToSong(p[0])||$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.jumptosong.failed",p[0]))),d.equalsIgnoreCase("skipsong")&&(currentPlaylist.nextVideo(),connectedPlayerClient.pushSongList()),d.equalsIgnoreCase("songrequest")){if(0==p.length)return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.songrequest.usage"));var q=currentPlaylist.requestSong(s.getArguments(),c);q?($.say($.lang.get("ytplayer.command.songrequest.success",$.resolveRank(c),q.getVideoTitle(),currentPlaylist.getRequestsCount(),q.getVideoId())),connectedPlayerClient.pushSongList()):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.songrequest.failed",currentPlaylist.getRequestFailReason()))}if(d.equalsIgnoreCase("wrongsong"))if(0==p.length){var C=currentPlaylist.removeUserSong(c);C?($.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.wrongsong.success",C)),connectedPlayerClient.pushSongList()):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.wrongsong.404"))}else if(p[0].equalsIgnoreCase("user")){if(p[1]){var C=currentPlaylist.removeUserSong(p[1].toLowerCase());C?($.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.wrongsong.user.success",p[1],C)),connectedPlayerClient.pushSongList()):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.wrongsong.404"))}}else $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.wrongsong.usage"));if(d.equalsIgnoreCase("previoussong")&&(currentPlaylist.getPreviousVideo()?$.say($.lang.get("ytplayer.command.previoussong",currentPlaylist.getPreviousVideo().getVideoTitle(),currentPlaylist.getPreviousVideo().getOwner(),currentPlaylist.getPreviousVideo().getVideoLink())):$.say($.lang.get("ytplayer.command.previoussong.404"))),d.equalsIgnoreCase("currentsong")&&$.say($.lang.get("ytplayer.command.currentsong",currentPlaylist.getCurrentVideo().getVideoTitle(),currentPlaylist.getCurrentVideo().getOwner(),currentPlaylist.getCurrentVideo().getVideoLink())),d.equalsIgnoreCase("nextsong")){var v,b;if(!p[0])return null==currentPlaylist.getRequestAtIndex(1)?void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.404")):void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.single",currentPlaylist.getRequestAtIndex(1).getVideoTitle()));if(!isNaN(p[0]))return null==currentPlaylist.getRequestAtIndex(parseInt(p[0]))?void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.404")):void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.single","#"+p[0]+": "+currentPlaylist.getRequestAtIndex(parseInt(p[0])).getVideoTitle()));if(p[0].equalsIgnoreCase("next")){if(!p[1])return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.usage"));if(isNaN(p[1]))return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.usage"));v=1,b=parseInt(p[1])}else{if(!p[0].equalsIgnoreCase("list"))return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.usage"));if(!p[1])return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.usage"));if(!p[1].match(/\d+\-\d+/))return void $.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.usage"));v=parseInt(p[1].match(/(\d)+\-\d+/)[1]),b=parseInt(p[1].match(/\d+\-(\d+)/)[1]),b-v>5&&(b=v+5)}for(var w="";b>=v&&null!=currentPlaylist.getRequestAtIndex(v);)w+="[(#"+v+") "+currentPlaylist.getRequestAtIndex(v).getVideoTitle().substr(0,20)+"] ",v++;w.equals("")?$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.range.404")):$.say($.whisperPrefix(c)+$.lang.get("ytplayer.command.nextsong.range",w))}}),$.bind("initReady",function(){if($.bot.isModuleEnabled("./systems/ytPlayer.js")&&($.registerChatCommand("./systems/ytPlayer.js","ytp",1),$.registerChatCommand("./systems/ytPlayer.js","playlist",1),$.registerChatCommand("./systems/ytPlayer.js","stealsong",1),$.registerChatCommand("./systems/ytPlayer.js","jumptosong",1),$.registerChatCommand("./systems/ytPlayer.js","skipsong",1),$.registerChatCommand("./systems/ytPlayer.js","songrequest"),$.registerChatCommand("./systems/ytPlayer.js","previoussong"),$.registerChatCommand("./systems/ytPlayer.js","currentsong"),$.registerChatCommand("./systems/ytPlayer.js","wrongsong"),$.registerChatCommand("./systems/ytPlayer.js","nextsong"),$.registerChatSubcommand("wrongsong","user",2),currentPlaylist=new t(r),currentPlaylist.getPlaylistname().equals("default")&&0==currentPlaylist.getplaylistLength())){try{currentPlaylist.addToPlaylist(new e("gotxnim9h8w",$.botName))}catch(s){$.logError("ytPlayer.js",839,"YoutubeVideo::exception: "+s)}try{currentPlaylist.addToPlaylist(new e("WFqO9DoZZjA",$.botName))}catch(s){$.logError("ytPlayer.js",846,"YoutubeVideo::exception: "+s)}try{new e("l7C29RM1UmU",$.botName);currentPlaylist.addToPlaylist(new e("l7C29RM1UmU",$.botName))}catch(s){$.logError("ytPlayer.js",855,"YoutubeVideo::exception: "+s)}}})}();
