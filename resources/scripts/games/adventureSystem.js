!function(){function e(){var e,t,s=1;for(s;$.lang.exists("adventuresystem.stories."+s+".title");s++){for(t=[],e=1;$.lang.exists("adventuresystem.stories."+s+".chapter."+e);e++)t.push($.lang.get("adventuresystem.stories."+s+".chapter."+e));P.push({title:$.lang.get("adventuresystem.stories."+s+".title"),lines:t})}$.consoleDebug($.lang.get("adventuresystem.loaded",s-1))}function t(){var e,t=$.inidb.GetKeyList("adventurePayouts",""),s=[],n=1,r=[];0==t.length&&$.say($.lang.get("adventuresystem.top5.empty"));for(e in t)t[e].equalsIgnoreCase($.ownerName)||t[e].equalsIgnoreCase($.botName)||s.push({username:t[e],amount:parseInt($.inidb.get("adventurePayouts",t[e]))});s.sort(function(e,t){return e.amount<t.amount?1:-1});for(e in s)5>=n&&(r.push(n+". "+s[e].username+": "+$.getPointsString(s[e].amount)),n++);$.say($.lang.get("adventuresystem.top5",r.join(", ")))}function s(e){var t;for(t in S.users)if(S.users[t].username==e)return!0;return!1}function n(e){var t,s=[];for(t in e)s.push($.username.resolve(e[t].username));return s.join(", ")}function r(){var e;for(e in S.users)$.randRange(0,20)>5?S.survivors.push(S.users[e]):S.caught.push(S.users[e])}function a(e){return e.indexOf("(caught)")>-1?S.caught.length>0?e.replace("(caught)",n(S.caught)):"":e.indexOf("(survivors)")>-1?S.survivors.length>0?e.replace("(survivors)",n(S.survivors)):"":e}function i(e,t){if($.bot.isModuleEnabled("./games/tamagotchi.js")){var s=$.tamagotchi.getByOwner(e);s&&(s.isHappy()?(s.incrFunLevel(p).incrExpLevel(b).decrFoodLevel(h).save(),$.say($.lang.get("adventuresystem.tamagotchijoined",s.name)),S.users.push({username:s.name,tgOwner:e,bet:t/2})):s.sayFunLevel())}}function u(e){S.gameState=1;var t=setTimeout(function(){g(),clearTimeout(t)},1e3*m);$.say($.lang.get("adventuresystem.start.success",$.resolveRank(e),$.pointNameMultiple))}function o(e,t){return S.gameState>1?void $.say($.whisperPrefix(e)+$.lang.get("adventuresystem.join.notpossible")):s(e)?void $.say($.whisperPrefix(e)+$.lang.get("adventuresystem.alreadyjoined")):t>$.getUserPoints(e)?void $.say($.whisperPrefix(e)+$.lang.get("adventuresystem.join.needpoints",$.getPointsString(t),$.getPointsString($.getUserPoints(e)))):y>t?void $.say($.whisperPrefix(e)+$.lang.get("adventuresystem.join.bettoolow",$.getPointsString(t),$.getPointsString(y))):t>f?void $.say($.whisperPrefix(e)+$.lang.get("adventuresystem.join.bettoohigh",$.getPointsString(t),$.getPointsString(f))):(S.users.push({username:e,bet:parseInt(t)}),$.inidb.decr("points",e,t),i(e,t),0==S.gameState?u(e):$.say($.whisperPrefix(e)+$.lang.get("adventuresystem.join.success",$.getPointsString(t))),!0)}function g(){var e,t,s=0,n=$.randElement(P);S.gameState=2,r(),$.say($.lang.get("adventuresystem.runstory",n.title,S.users.length)),t=setInterval(function(){s<n.lines.length?(e=a(n.lines[s]),""!=e&&$.say(e)):(v(),clearInterval(t)),s++},5e3)}function v(){var e,t;for(e in S.survivors)S.survivors[e].tgOwner&&(S.survivors[e].username=S.survivors[e].tgOwner),t=S.survivors[e].bet*(c/100),$.inidb.incr("adventurePayouts",S.survivors[e].username,t),$.inidb.incr("points",S.survivors[e].username,S.survivors[e].bet+t);$.say($.lang.get("adventuresystem.completed",S.survivors.length,S.caught.length)),d(),$.coolDown.set("adventure",l)}function d(){S={gameState:0,users:[],tgOwners:[],survivors:[],caught:[]}}var m=$.getSetIniDbNumber("adventureSettings","joinTime",60),l=$.getSetIniDbNumber("adventureSettings","coolDown",900),c=$.getSetIniDbNumber("adventureSettings","gainPercent",30),y=$.getSetIniDbNumber("adventureSettings","minBet",10),f=$.getSetIniDbNumber("adventureSettings","maxBet",1e3),p=1,b=.5,h=.25,S=1,P=[],w=!1;$.bind("command",function(e){var s=e.getSender().toLowerCase(),n=e.getCommand(),r=e.getArgs(),a=r[0],i=r[1],u=parseInt(r[2]);if(n.equalsIgnoreCase("adventure")){if(!a)return void $.say($.whisperPrefix(s)+$.lang.get("adventuresystem.adventure.usage",$.pointNameMultiple));if(!isNaN(parseInt(a)))return void o(s,parseInt(a));if(a.equalsIgnoreCase("top5")&&t(),a.equalsIgnoreCase("set")){if(!$.isAdmin(s))return void $.say($.whisperPrefix(s)+$.adminMsg);if(!i||isNaN(u))return void $.say($.whisperPrefix(s)+$.lang.get("adventuresystem.set.usage"));i.equalsIgnoreCase("joinTime")&&(m=u,$.inidb.set("adventureSettings","joinTime",u)),i.equalsIgnoreCase("coolDown")&&(l=u,$.inidb.set("adventureSettings","coolDown",u)),i.equalsIgnoreCase("gainPercent")&&(c=u,$.inidb.set("adventureSettings","gainPercent",u)),i.equalsIgnoreCase("minBet")&&(y=u,$.inidb.set("adventureSettings","minBet",u)),i.equalsIgnoreCase("maxBet")&&(f=u,$.inidb.set("adventureSettings","maxBet",u)),$.say($.whisperPrefix(s)+$.lang.get("adventuresystem.set.success",i,u))}}}),$.bind("initReady",function(){$.bot.isModuleEnabled("./games/adventureSystem.js")&&(d(),w||(e(),w=!0),$.registerChatCommand("./games/adventureSystem.js","adventure",7))}),$.bot.isModuleEnabled("./games/adventureSystem.js")&&!$.bot.isModuleEnabled("./systems/pointSystem.js")&&$.logError("adventureSystem.js",402,"Disabled. ./systems/pointSystem.js is not enabled.")}();
