/*
 * customCommandsPanel.js
 * Drives the Custom Commands Panel
 */
(function() {
    var groupIcons = [];
        groupIcons['0'] = "<i class=\"fa fa-television\" />";
        groupIcons['1'] = "<i class=\"fa fa-laptop\" />";
        groupIcons['2'] = "<i class=\"fa fa-shield\" />";
        groupIcons['3'] = "<i class=\"fa fa-credit-card\" />";
        groupIcons['6'] = "<i class=\"fa fa-clock-o\" />";
        groupIcons['7'] = "<i class=\"fa fa-user\" /></div>";

    /*
     * onMessage
     * This event is generated by the connection (WebSocket) object.
     */
    function onMessage(message) {
        try {
            var msgObject = JSON.parse(message.data);
        } catch (ex) {
            return;
        }
        // Check for dbkeysresult queries
        if (msgObject['dbkeysresult'] != undefined) {
            var commandName = "",
                commandValue = "",
                html = "<table>";

            if (msgObject['dbkeysresult'].localeCompare('commands_commands') == 0) {
                for (idx in msgObject['results']) {
                    commandName = msgObject['results'][idx]['key'];
                    commandValue = msgObject['results'][idx]['value'];
                    html += "<tr class=\"textList\">" +
                            "<td padding=\"5px\"><div class=\"button\" onclick=\"$.deleteCommand('" + commandName + "')\"><i class=\"fa fa-trash\" /></button></td>" +
                            "<td><strong>" + commandName + "</strong></td>" +
                            "<td>" + commandValue + "</td>" +
                            "</tr>";
                }
                html += "</table>";
                $("#customCommandsList").html(html);
            }

            if (msgObject['dbkeysresult'].localeCompare('commands_aliases') == 0) {
                for (idx in msgObject['results']) {
                    commandName = msgObject['results'][idx]['key'];
                    commandValue = msgObject['results'][idx]['value'];
                    html += "<tr class=\"textList\">" +
                            "<td padding=\"5px\"><div class=\"button\" onclick=\"$.deleteAlias('" + commandName + "')\"><i class=\"fa fa-trash\" /></button></td>" +
                            "<td><strong>" + commandName + "</strong></td>" +
                            "<td>" + commandValue + "</td>" +
                            "</tr>";
                }
                html += "</table>";
                $("#aliasCommandsList").html(html);
            }

            if (msgObject['dbkeysresult'].localeCompare('commands_pricecom') == 0) {
                for (idx in msgObject['results']) {
                    commandName = msgObject['results'][idx]['key'];
                    commandValue = msgObject['results'][idx]['value'];
                    html += "<tr class=\"textList\">" +
                            "<td style=\"vertical-align: middle\"><strong>" + commandName + "</strong></td>" +
                            "<td style=\"vertical-align: middle\">" + commandValue + "</td>" +
                            "<td style=\"vertical-align: middle\">" +
                            "    <form onkeypress=\"return event.keyCode != 13\">" +
                            "        <input type=\"text\" id=\"inlineCommandPrice\" placeholder=\"new_price\" />" +
                            "        <input type=\"button\" value=\"Update\" onclick=\"$.updateCommandPrice('" + commandName + "')\">" +
                            "    </form>" +
                            "</td>" +
                            "</tr>";
                }
                html += "</table>";
                $("#priceCommandsList").html(html);
            }

            if (msgObject['dbkeysresult'].localeCompare('commands_permcom') == 0) {
                for (idx in msgObject['results']) {
                    commandName = msgObject['results'][idx]['key'];
                    commandValue = msgObject['results'][idx]['value'];
                    html += "<tr class=\"textList\">" +
                            "<td><strong>" + commandName + "</strong></td>" +
                            "<td><strong><font style=\"color: blue\">" + groupIcons[commandValue] + "</font></strong></td>" +

                            "<td><div data-toggle=\"tooltip\" title=\"Set Caster\" class=\"button\" onclick=\"$.commandPermission('" + commandName + "', 0);\">" +
                            "    <i class=\"fa fa-television\" /></div>" +

                            "<td><div data-toggle=\"tooltip\" title=\"Set Admin\" class=\"button\" onclick=\"$.commandPermission('" + commandName + "', 1);\">" +
                            "    <i class=\"fa fa-laptop\" /></div>" +

                            "<td><div data-toggle=\"tooltip\" title=\"Set Mod\" class=\"button\" onclick=\"$.commandPermission('" + commandName + "', 2);\">" +
                            "    <i class=\"fa fa-shield\" /></div>" +

                            "<td><div data-toggle=\"tooltip\" title=\"Set Sub\" class=\"button\" onclick=\"$.commandPermission('" + commandName + "', 3);\">" +
                            "    <i class=\"fa fa-credit-card\" /></div>" +

                            "<td><div data-toggle=\"tooltip\" title=\"Set Regular\" class=\"button\" onclick=\"$.commandPermission('" + commandName + "', 6);\">" +
                            "    <i class=\"fa fa-clock-o\" /></div>" +

                            "<td><div data-toggle=\"tooltip\" title=\"Set Viewer\" class=\"button\" onclick=\"$.commandPermission('" + commandName + "', 7);\">" +
                            "    <i class=\"fa fa-user\" /></div>" +

                            "</tr>";
                }
                html += "</table>";
                $("#permCommandsList").html(html);
            }
        }
    }

    /**
     * @function doQuery
     */
    function doQuery() {
        sendDBKeys("commands_commands", "command");
        sendDBKeys("commands_aliases", "aliases");
        sendDBKeys("commands_permcom", "permcom");
        sendDBKeys("commands_pricecom", "pricecom");
    }

    /** 
     * @function deleteCommand
     * @param {String} command
     */
    function deleteCommand(command) {
        sendCommand("delcom " + command);
        setTimeout(function() { doQuery(); }, 1000);
    }

    /**
     * @function addCustomCommand
     */
    function addCustomCommand() {
        sendCommand("addcom " + $("#addCommandInput").val());
        $("#addCommandInput").val("Submitted");
        setTimeout(function() { $("#addCommandInput").val(""); }, 1000);
        doQuery();
    }

    /**
     * @function editCustomCommand
     */
    function editCustomCommand() {
        sendCommand("editcom " + $("#editCommandInput").val());
        $("#editCommandInput").val("Submitted");
        setTimeout(function() { $("#editCommandInput").val(""); }, 1000);
        doQuery();
    }

    /** 
     * @function aliasCommand
     */
    function aliasCommand() {
        sendCommand("aliascom " + $("#aliasCommandInput").val());
        $("#aliasCommandInput").val("Submitted");
        setTimeout(function() { $("#aliasCommandInput").val(""); }, 1000);
        doQuery();
    }

    /**
     * @function deleteAlias
     * @param {String} command
     */
    function deleteAlias(command) {
       sendCommand("delalias " + command);
       setTimeout(function() { doQuery(); }, 1000);
    }

    /**
     * @function commandPermission
     */
    function commandPermission(command, group) {
        sendCommand("permcom " + command + " " + group);
        setTimeout(function() { doQuery(); }, 1000);
    }

    /**
     * @function setCommandPrice
     */
    function setCommandPrice() {
        sendCommand("pricecom " + $("#setCommandPriceInput").val());
        $("#setCommandPriceInput").val("Submitted");
        setTimeout(function() { $("#setCommandPriceInput").val(""); }, 1000);
        doQuery();
    }

    /**
     * @function updateCommandPrice
     */
    function updateCommandPrice(command) {
        sendCommand("pricecom " + command + " " + $("#inlineCommandPrice").val());
        $("#inlineCommandPrice").val("Submitted");
        setTimeout(function() { $("#inlineCommandPrice").val(""); }, 1000);
        doQuery();
    }


    // Import the HTML file for this panel.
    $("#commandsPanel").load("/panel/commands.html");

    // Load the DB items for this panel, wait to ensure that we are connected.
    var interval = setInterval(function() {
        if (isConnected) {
            doQuery();
            clearInterval(interval); 
        }
    }, 1000);

    // Query the DB every 30 seconds for updates.
    setInterval(function() {
        if (isConnected) {
            newPanelAlert('Refreshing Data', 'success', 500);
            doQuery();
        }
    }, 3e4);

    // Export functions - Needed when calling from HTML.
    $.commandsOnMessage = onMessage;
    $.deleteCommand = deleteCommand;
    $.addCustomCommand = addCustomCommand;
    $.editCustomCommand = editCustomCommand;
    $.aliasCommand = aliasCommand;
    $.deleteAlias = deleteAlias;
    $.commandPermission = commandPermission;
    $.setCommandPrice = setCommandPrice;
    $.updateCommandPrice = updateCommandPrice;
})();
