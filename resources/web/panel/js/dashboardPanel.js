/*
 * dashboardPanel.js
 * Drives the Dashboard Panel
 */
(function() {

    var panelStatsEnabled = false;
    var streamOnline = false;
    var curDate = $.format.date(new Date(), "MM.dd.yy");

    /*
     * @event connection.onmessage
     * This event is generated by the connection (WebSocket) object.
     */
    connection.onmessage = function(message) {
        try {
            var msgObject = JSON.parse(message.data);
        } catch (ex) {
            return;
        }

        // Check for dbkeysresult queries
        if (msgObject['dbkeysresult'] != undefined) {
            if (msgObject['dbkeysresult'].localeCompare('highlights') == 0) {
                var htmlStr = "";
                for (var i in msgObject['results']) {
                    var highlightData = msgObject['results'][i]['value'];
                    htmlStr += highlightData + "<br>";
                }
                if (htmlStr.length == 0) {
                    $("#showHighlights").html("No Highlights Found");
                } else {
                    $("#showHighlights").html(htmlStr);
                }
            }
        }

        // Check for dbqueryresult queries
        if (msgObject['dbqueryresult'] != undefined) {

            if (msgObject['dbqueryresult'].localeCompare('panelStatsEnabled') == 0) {
                if (msgObject['result']['enabled'].localeCompare('true') == 0) {
                    if (!panelStatsEnabled) {
                        panelStatsEnabled = true;
                        doQuery(); // Run the query again to populate fields.
                    }
                } else {
                    $("#panelStatsEnabled").html("<span>Panel Stats are Disabled</span>");
                }
            }

            if (msgObject['dbqueryresult'].localeCompare('streamTitle') == 0) {
                $("#streamTitleInput").attr("placeholder", msgObject['result']['title']).blur();
            }
 
            if (msgObject['dbqueryresult'].localeCompare('gameTitle') == 0) {
                $("#gameTitleInput").attr("placeholder", msgObject['result']['game']).blur();
            }
 
            if (msgObject['dbqueryresult'].localeCompare('streamOnline') == 0) {
                streamOnline = (msgObject['result']['streamOnline'].localeCompare('true') == 0);
                if (streamOnline) {
                    $("#streamOnline").html("<span class=\"greenPill\">Stream Online</span>");
                } else {
                    $("#streamOnline").html("<span class=\"redPill\">Stream Offline</span>");
                }
            }

            if (msgObject['dbqueryresult'].localeCompare('chatCount') == 0) {
                $("#chatDate").html("<span class=\"purplePill\">Date: " + curDate + "</span>");
                if (msgObject['result'][curDate] != undefined) {
                    $("#chatCount").html("<span class=\"bluePill\">Chat Count: " + msgObject['result']['chat_'+curDate] + "</span>");
                } else {
                    $("#chatCount").html("<span class=\"bluePill\">Chat Count: 0</span>");
                }
            }

            if (msgObject['dbqueryresult'].localeCompare('modCount') == 0) {
                if (msgObject['result'][curDate] != undefined) {
                    $("#modCount").html("<span class=\"redPill\">Timeouts: " + msgObject['result']['chat_'+curDate] + "</span>");
                } else {
                    $("#modCount").html("<span class=\"redPill\">Timeouts: 0</span>");
                }
            }

            if (streamOnline) {
                if (msgObject['dbqueryresult'].localeCompare('streamUptime') == 0) {
                    $("#streamUptime").html("<span class=\"bluePill\">Uptime: " + msgObject['result']['streamUptime']);
                }
                if (msgObject['dbqueryresult'].localeCompare('viewerCount') == 0) {
                    $("#viewerCount").html("<span class=\"bluePill\">Viewers: " + msgObject['result']['viewerCount']);
                }
            }
        }
    }

    /**
     * @function doQuery
     */
    function doQuery() {
        sendDBQuery("streamTitle", "streamInfo", "title");
        sendDBQuery("gameTitle", "streamInfo", "game");
        sendDBKeys("highlights", "highlights");

        if (!panelStatsEnabled) {
            sendDBQuery("panelStatsEnabled", "panelstats", "enabled");
        } else {
            sendDBQuery("viewerCount", "panelstats", "viewerCount");
            sendDBQuery("streamOnline", "panelstats", "streamOnline");
            sendDBQuery("streamUptime", "panelstats", "streamUptime");
            sendDBQuery("chatCount", "panelchatstats", "chat_" + curDate);
            sendDBQuery("modCount", "panelchatstats", "mod_" + curDate);
        }
    }

    /**
     * @function setStreamTitle
     */
    function setStreamTitle() {
        sendCommand("title " + $("#streamTitleInput").val());
    }

    /**
     * @function setGameTitle
     */
    function setGameTitle() {
        sendCommand("game " + $("#gameTitleInput").val());
    }

    /**
     * @function setHighlight
     */
    function setHighlight() {
        sendCommand("highlight " + $("#highlightInput").val());
    }

    /**
     * @function clearHighlights
     */
    function clearHighlights() {
        sendCommand("clearhighlights");
    }

    /**
     * @function setMultiLink
     */
    function setMultiLink() {
        sendCommand("multi set " + $("#multiLinkInput").val());
    }
    
    /**
     * @function setMultiLinkTimer
     */
    function setMultiLinkTimer() {
        sendCommand("multi timerinterval " + $("#multiLinkTimerInput").val());
    }

    /**
     * @function clearMultiLink
     */
    function clearMultiLink() {
        sendCommand("multi clear");
    }
 
    /**
     * @function multiLinkTimerOn
     */
    function multiLinkTimerOn() {
        sendCommand("multi timer on");
    }
 
    /**
     * @function multiLinkTimerOff
     */
    function multiLinkTimerOff() {
        sendCommand("multi timer off");
    }
 
    // Import the HTML file for this panel.
    $("#dashboardPanel").load("/panel/dashboard.html");

    // Load the DB items for this panel, wait to ensure that we are connected.
    var interval = setInterval(function() {
        if (isConnected) {
            curDate = $.format.date(new Date(), "MM.dd.yy");
            doQuery();
            clearInterval(interval); 
        }
    }, 1000);

    // Query the DB every 30 seconds for updates.
    setInterval(function() {
        if (isConnected) {
            newPanelAlert('Refreshing Data', 'success', 500);
            curDate = $.format.date(new Date(), "MM.dd.yy");
            doQuery();
        }
    }, 3e4);

    // Export functions - Needed when calling from HTML.
    $.setStreamTitle = setStreamTitle;
    $.setGameTitle = setGameTitle;
    $.setHighlight = setHighlight;
    $.clearHighlights = clearHighlights;
    $.setMultiLink = setMultiLink;
    $.setMuliLinkTimer = setMultiLinkTimer;
    $.clearMultiLink = clearMultiLink;
    $.multiLinkTimerOn = multiLinkTimerOn;
    $.multiLinkTimerOff = multiLinkTimerOff;
})();
