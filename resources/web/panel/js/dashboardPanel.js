/*
 * dashboardPanel.js
 * Drives the Dashboard Panel
 */
(function() {

    var panelStatsEnabled = false;
    var streamOnline = false;
    var curDate = $.format.date(new Date(), "MM.dd.yy");

    /*
     * @event connection.onmessage
     * This event is generated by the connection (WebSocket) object.
     */
    connection.onmessage = function(message) {
        try {
            var msgObject = JSON.parse(message.data);
        } catch (ex) {
            return;
        }

        if (msgObject['dbqueryresult'] != undefined) {

            if (msgObject['dbqueryresult'].localeCompare('panelStatsEnabled') == 0) {
                if (msgObject['result']['enabled'].localeCompare('true') == 0) {
                    if (!panelStatsEnabled) {
                        panelStatsEnabled = true;
                        doQuery(); // Run the query again to populate fields.
                    }
                } else {
                    $("#panelStatsEnabled").html("<span>Panel Stats are Disabled</span>");
                }
            }
 
            if (msgObject['dbqueryresult'].localeCompare('streamTitle') == 0) {
                $("#streamTitleInput").attr("placeholder", msgObject['result']['title']).blur();
            }
 
            if (msgObject['dbqueryresult'].localeCompare('gameTitle') == 0) {
                $("#gameTitleInput").attr("placeholder", msgObject['result']['game']).blur();
            }
 
            if (msgObject['dbqueryresult'].localeCompare('streamOnline') == 0) {
                streamOnline = (msgObject['result']['streamOnline'].localeCompare('true') == 0);
                if (streamOnline) {
                    $("#streamOnline").html("<span class=\"greenPill\">Stream Online</span>");
                } else {
                    $("#streamOnline").html("<span class=\"redPill\">Stream Offline</span>");
                }
            }

            if (msgObject['dbqueryresult'].localeCompare('chatCount') == 0) {
                if (msgObject['result'][curDate] != undefined) {
                    $("#chatCount").html("<span class=\"bluePill\">Chat Count: " + msgObject['result']['chat_'+curDate] + "</span>");
                } else {
                    $("#chatCount").html("<span class=\"bluePill\">Chat Count: 0</span>");
                }
            }

            if (msgObject['dbqueryresult'].localeCompare('modCount') == 0) {
                if (msgObject['result'][curDate] != undefined) {
                    $("#modCount").html("<span class=\"redPill\">Timeouts: " + msgObject['result']['chat_'+curDate] + "</span>");
                } else {
                    $("#modCount").html("<span class=\"redPill\">Timeouts: 0</span>");
                }
            }
 
            if (streamOnline) {
                if (msgObject['dbqueryresult'].localeCompare('streamUptime') == 0) {
                    $("#streamUptime").html("<span class=\"bluePill\">Uptime: " + msgObject['result']['streamUptime']);
                }
                if (msgObject['dbqueryresult'].localeCompare('viewerCount') == 0) {
                    $("#viewerCount").html("<span class=\"bluePill\">Viewers: " + msgObject['result']['viewerCount']);
                }
            }
        }
    }

    /**
     * @function doQuery
     */
    function doQuery() {
        var jsonObject = {};

        jsonObject["dbquery"] = "streamTitle";
        jsonObject["query"] = { "table": "streamInfo", "key": "title" };
        connection.send(JSON.stringify(jsonObject));

        jsonObject["dbquery"] = "gameTitle";
        jsonObject["query"] = { "table": "streamInfo", "key": "game" };
        connection.send(JSON.stringify(jsonObject));

        if (!panelStatsEnabled) {
            jsonObject["dbquery"] = "panelStatsEnabled";
            jsonObject["query"] = { "table": "panelstats", "key": "enabled" };
            connection.send(JSON.stringify(jsonObject));
        }

        if (panelStatsEnabled) {
            jsonObject["dbquery"] = "viewerCount";
            jsonObject["query"] = { "table": "panelstats", "key": "viewerCount" };
            connection.send(JSON.stringify(jsonObject));

            jsonObject["dbquery"] = "streamOnline";
            jsonObject["query"] = { "table": "panelstats", "key": "streamOnline" };
            connection.send(JSON.stringify(jsonObject));
    
            jsonObject["dbquery"] = "streamUptime";
            jsonObject["query"] = { "table": "panelstats", "key": "streamUptime" };
            connection.send(JSON.stringify(jsonObject));

            jsonObject["dbquery"] = "chatCount";
            jsonObject["query"] = { "table": "panelchatstats", "key": "chat_" + curDate };
            connection.send(JSON.stringify(jsonObject));

            jsonObject["dbquery"] = "modCount";
            jsonObject["query"] = { "table": "panelchatstats", "key": "mod_" + curDate };
            connection.send(JSON.stringify(jsonObject));
        }
    }

    /**
     * @function setStreamTitle
     */
    function setStreamTitle() {
        var jsonObject = {};
        jsonObject["command"] = "title " + $("#streamTitleInput").val();
        jsonObject["username"] = "illusionarybot";
        connection.send(JSON.stringify(jsonObject));
    }

    /**
     * @function setGameTitle
     */
    function setGameTitle() {
        var jsonObject = {};
        jsonObject["command"] = "game " + $("#gameTitleInput").val();
        jsonObject["username"] = "illusionarybot";
        connection.send(JSON.stringify(jsonObject));
    }

    // Import the HTML file for this panel.
    $("#dashboardPanel").load("/panel/dashboard.html");

    // Load the DB items for this panel, wait to ensure that we are connected.
    var interval = setInterval(function() {
        if (isConnected) {
            curDate = $.format.date(new Date(), "MM.dd.yy");
            doQuery();
            clearInterval(interval); 
        }
    }, 1000);

    // Query the DB every minute for updates.
    setInterval(function() {
        if (isConnected) {
            curDate = $.format.date(new Date(), "MM.dd.yy");
            doQuery();
        }
    }, 6e4);

    // Export functions - Needed when calling from HTML.
    $.setStreamTitle = setStreamTitle;
    $.setGameTitle = setGameTitle;

})();
